# Integrations

This directory contains a `docker-compose.yaml` that provisions a complete test environment for **gwmilter**. The setup includes the following services:

- **key-generator**: Bootstrapping container. It generates a signing key for internal use by **gwmilter** and encryption keys as listed in `key_list.txt`. The generated keys are stored in a local directory (`integrations/keys` by default). The public part of the keys is imported in the **gwmilter** container at startup.
- **gwmilter**: The email encryption gateway, built from the local source code. At startup, the container imports the public keys generated by `key-generator` container.
- **postfix-gw**: A [**Postfix**](https://www.postfix.org) MTA configured to use **gwmilter** as a [milter](https://en.wikipedia.org/wiki/Milter). It is configured to relay all emails to [**mailpit**](https://mailpit.axllent.org).
- **key-server**: An HKP key server that serves the public keys generated by `key-generator`. This allows **gwmilter** to fetch keys for recipients if they are not already in its local keyring.
- **mailpit**: A web-based SMTP testing tool for capturing and viewing emails. It is accessible at [http://localhost:8025](http://localhost:8025)

A setup that does not start the **gwmilter** container is provided too: `docker-compose-no-gwmilter.yaml`. This is meant to facilitate running **gwmilter** locally during development. The `integrations/dev.sh` script can generate a **gwmilter** configuration file for local use, based on `integrations/gwmilter/config.ini.template`.
Detailed instructions for building **gwmilter** are available in [LOCAL_DEV.md](https://github.com/drclau/gwmilter/blob/main/DEV_GUIDE.md).

Additionally, a `docker-compose-tests.yaml` file is provided to run automated end-to-end tests. This setup extends the main `docker-compose.yaml` environment and adds a **tests** service. The **tests** service uses `pytest` to execute tests defined in the `tests/` directory, interacting with the other services like `gwmilter`, `postfix-gw`, and `key-server` to validate the end-to-end functionality. This offers an alternative to running the tests on the host machine.


## Manual Testing with **swaks**

You can manually test the setup by sending emails through the Postfix gateway using [**swaks**](https://jetmore.org/john/code/swaks/):
> **Note:** The following instructions assume your current directory is the project root.

### 1. **Start the environment:**
```sh
docker compose -f integrations/docker-compose.yaml up --build
```

or, if you plan to run **gwmilter** locally:

```sh
docker compose -f integrations/docker-compose-no-gwmilter.yaml up --build

# in a separate terminal, generate the gwmilter configuration file:
./integrations/dev.sh

# make sure you built a fresh version of gwmilter, and then start it:
./build/gwmilter -c dev-config.ini
```

### 2. **Send a test email:**
```sh
swaks --to recipient@example.com --from sender@example.com --server localhost:25
```
- Replace `recipient@example.com` with a test address configured for encryption. See `key_list.txt` for a list of PGP keys that are available for testing.
- You can adjust the **swaks** parameters to test different scenarios, such as attachments or custom headers.
- The email will be processed by **gwmilter** and delivered to **mailpit**.
- **What to expect:**
    - emails sent to recipients matching `.*-pgp@example.com` will be PGP encrypted if there are public keys available:
        - `pgp-valid-present-01@example.com` and `pgp-valid-present-02@example.com` have valid keys in the **GnuPG** keyring, hence the email is encrypted.
        - `pgp-valid-missing-01@example.com` has a valid key, but it has not been imported into the **GnuPG** keyring during the startup of the **gwmilter** container. Sending an email to this recipient will trigger the retrieval of the public key from the key server, and subsequently the email is encrypted.
        - `pgp-expired-present-01@example.com` and `pgp-expired-missing-01@example.com` have expired keys, hence are rejected as recipients.
    - emails sent to `user-smime@example.com` will be encrypted with S/MIME, _if_ a certificate is available. **Currently,** the integrations environment does not handle the generation or importing of S/MIME certificates.
    - emails sent to `user-pdf@example.com` will be converted to a password protected PDF.
    - emails sent to `.*@example.com` will be forwarded as-is.
    - emails sent to recipients on domains other than `@example.com` will fail.
    - **See `integrations/gwmilter/config.ini.template` for more details.**


### 3. **View the result:**
- Open [http://localhost:8025](http://localhost:8025) in your browser to inspect the delivered email in **mailpit**.
- PGP encrypted emails are shown as empty. Go to the **Raw** view to see the email source.
- To decrypt the email, you can:
    - Make sure the private keys (i.e., `integrations/keys/private/*.pgp`) are imported into your [**GnuPG**](https://gnupg.org) keyring.
    - Download the raw message from **mailpit**.
    - Decrypt it with `gpg`:
```sh
gpg -d encrypted.eml
```

### 4. **[optional] Cleanup**

- If you want to re-generate the keys, remove the generated keys directory (`integrations/keys`)
- If you want to re-import the public keys, or otherwise start with a clean environment:
```sh
docker compose -f integrations/docker-compose.yaml down -v
```
